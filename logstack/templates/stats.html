{% extends "base.html" %}
{% block title %}Stats{% endblock %}
{% block body %}
<div class="panel">
  <input id="prefix" placeholder="Prefix" value="{{ prefix or '' }}">
  <select id="order_by">
    {% for col in ["count","mean","median","stddev","min","max"] %}
      <option value="{{ col }}" {% if order_by==col %}selected{% endif %}>{{ col }}</option>
    {% endfor %}
  </select>
  <label><input type="checkbox" id="descending" {% if descending %}checked{% endif %}> Desc</label>
  <button onclick="loadStats()">Refresh</button>
</div>

<div class="panel chart-container" id="statsChart"></div>

<script>
let statsChartInstance;
async function loadStats() {
  const payload = {
    prefix: document.getElementById('prefix').value,
    order_by: document.getElementById('order_by').value,
    descending: document.getElementById('descending').checked
  };
  const res = await fetch('/api/data/stats', {
    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
  });
  const { result } = await res.json();
  const labels = result.map(r => r.prefix);
  const dataMean = result.map(r => r.mean);
  const dataMedian = result.map(r => r.median);
  const dataCount = result.map(r => r.count);
  const dataStddev = result.map(r => r.stddev);
  const dataMin = result.map(r => r.min);
  const dataMax = result.map(r => r.max);
  if (!statsChartInstance) {
    statsChartInstance = echarts.init(document.getElementById('statsChart'));
  }
  statsChartInstance.setOption({
    tooltip: { trigger: 'axis' },
    legend: { data: ['Count', 'Mean', 'Median', 'Stddev', 'Min', 'Max'], textStyle: { color: '#ccc' } },
    xAxis: { type: 'category', data: labels, axisLabel: { color: '#aaa' }},
    yAxis: [
      { type: 'value', name: 'Stats', axisLabel: { color: '#aaa' }},
      { type: 'value', name: 'Count', axisLabel: { color: '#aaa' }, position: 'right' }
    ],
    series: [
      { name: 'Count', type: 'line', data: dataCount, yAxisIndex: 1 },
      { name: 'Mean', type: 'bar', data: dataMean },
      { name: 'Median', type: 'bar', data: dataMedian },
      { name: 'Stddev', type: 'bar', data: dataStddev },
      { name: 'Min', type: 'bar', data: dataMin },
      { name: 'Max', type: 'bar', data: dataMax },
    ]
  });
}
loadStats();
</script>
{% endblock %}
